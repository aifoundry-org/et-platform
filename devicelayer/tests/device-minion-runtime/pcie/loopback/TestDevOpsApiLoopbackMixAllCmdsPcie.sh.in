#!/bin/bash

#------------------------------------------------------------------------------
# Copyright (C) 2021, Esperanto Technologies Inc.
# The copyright to the computer program(s) herein is the
# property of Esperanto Technologies, Inc. All Rights Reserved.
# The program(s) may be used and/or copied only with
# the written permission of Esperanto Technologies and
# in accordance with the terms and conditions stipulated in the
# agreement/contract under which the program(s) have been supplied.
#------------------------------------------------------------------------------

RUN_DIR=@CMAKE_CURRENT_BINARY_DIR@
cd $RUN_DIR

if [ -n "$1" ]; then
    TESTS_DURATION=$1
else
    ## Default test duration
    TESTS_DURATION="5minute"
fi
echo "Tests duration is $TESTS_DURATION"

ops_tests=($(ctest -N -L LOOPBACK | awk '$2 ~ /#[0-9]+:/ && $4 !~ /Disabled/ {print $3}'))
ops_tests_count=${#ops_tests[@]}
if [[ $ops_tests_count -eq 0 ]]; then
    exit 1
fi

## save logs for one test and print at once. This will be helpful when
## mgmt and ops tests be executed in parallel
ops_tests_logfile=$(mktemp)
ops_tests_endtime=$(date -ud "$TESTS_DURATION" +%s)
while [[ $(date -u +%s) -le $ops_tests_endtime ]]
do
    ops_exec_idx=$(($RANDOM % $ops_tests_count))
    sudo ctest -R ${ops_tests[$ops_exec_idx]} -V > $ops_tests_logfile
    ops_tests_rv=$?
    cat $ops_tests_logfile
    if [ $ops_tests_rv -ne 0 ]; then
        rm $ops_tests_logfile
        exit $ops_tests_rv
    fi
done
rm $ops_tests_logfile
