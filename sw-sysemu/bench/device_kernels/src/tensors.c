#include "macros.h"
#include "etsoc/isa/tensors.h"
#include "etsoc/isa/cacheops.h"
#include "etsoc/isa/hart.h"

static inline void evict_dcache(void)
{
    register uint64_t set asm("a7");
    for(set = 0; set < L1D_NUM_SETS; set++)
    {
        // use_tmask=0, dst=1 (L2/SP_RAM), set=X, way=0, num_lines=15
        __asm__ __volatile__(
            // Wait for previous memory accesses to finish
            "fence\n"
            // Evict L1 Dcache: EvictSW for the 4 ways
            "csrw evict_sw, %0\n"
            "addi %0, %0, 64\n"
            "csrw evict_sw, %0\n"
            "addi %0, %0, 64\n"
            "csrw evict_sw, %0\n"
            "addi %0, %0, 64\n"
            "csrw evict_sw, %0\n"
            "addi %0, %0, 64\n"
            // Wait for the evicts to complete
            "csrwi tensor_wait, 6\n"
            : 
            : "r"((1ull << 58) + ((set & 0xF) << 14) + 15ull)
            : "memory");
    }
	set = 0;
}

void setup_cache_scp(){
    // PRM-8: Cache Control Extension
    EXCL_MODE(1);
    // Evict the whole L1$
    evict_dcache();
    // Shared Mode
    MCACHE_CONTROL(0, 0, 0, 0);
    WAIT_CACHEOPS;
    // D1Split Mode
    MCACHE_CONTROL(0, 0, 0, 1);
    WAIT_CACHEOPS;
    // Scratchpad Mode
    MCACHE_CONTROL(0, 0, 1, 1);
    WAIT_CACHEOPS;
    EXCL_MODE(0);
}

int main() {
	float f1 = 84.06252567881609, f2 = 89.20805315334098, f3 = 1.7801832803936435, output;
	(void)f1;
	(void)f2;
	(void)f3;
	(void)output;
/* Tensors */
	evict_dcache();
	setup_cache_scp();
	int hart_id = get_hart_id();
	int thread_id = get_thread_id();
	if(thread_id == 0) {
		tensor_wait(thread_id);
		tensor_load(0, 0, 0, 7, 0, 0x8100000000 + hart_id * 0x4000, 0, 15, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_float(0, 0, 7, 0, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce_send(0, 8, 0);
		tensor_wait(thread_id);
		tensor_fma(0, 13, 5, 14, 3, 0, 0, 0, 0, 0, 0, 011, 0);
		tensor_wait(thread_id);
		tensor_reduce_uint32(0, 0, 0, 0);
		tensor_wait(thread_id);
		tensor_reduce(0, 0, 9, 0, 0);
		tensor_wait(thread_id);
	}
}