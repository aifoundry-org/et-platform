include:
  - project: 'esperantotech/software/gitlab-ci-common'
    ref: 1be8a1ec31da665910e1b2b193fcfa1d05866299
    file:
      - 'pods/nano-pod.yaml'
      - 'jobs/generic-k8s-job.yaml'
      - 'jobs/sw-platform-trigger-template.yaml'
      - 'jobs/check-top-of-master-template.yaml'
  
  - project: 'esperantotech/software/gitlab-ci-common'
    ref: master
    file:
      - 'jobs/conan-jobs.yaml'

  - project: 'esperantotech/software/sw-platform'
    ref: develop/system-sw
    file:
      - gitlab-ci/system-sw/misc/verify-merge-request.yaml

default:
  interruptible: true
  image: docker-sw-team.sc-artifactory1.esperanto.ai/convoke/ubuntu-22.04-et-sw-platform:0.0.12

stages:
  - generate_build
  - build
  - test
  - deploy

workflow:
  rules:
    # Run this job when a tag is created manually
    - if: $CI_COMMIT_TAG
    # Do not execute the pipeline on a push event that doesn't happen to the master or main branch
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH'
      when: never
    # If any of the previous conditions are met, then execute the pipeline
    - when: always

variables:
  # These variables are consumed by the jobs from /jobs/sw-platform-trigger.yaml
  SW_PLATFORM_BRANCH: develop/system-sw
  PIPELINE_CI_SUBPROJECT: et-driver
  TRIG_ON_TAGS_PUSH: 'true'
  EXTRA_OPTION_SUBPROJECT: $CI_PIPELINE_SOURCE

# Only run job in these cases:
# - if it's a tag pipeline
# - if there is a commit pushed or merged to the default branch (pre-release)
.release_job:
  rules:
    - &release_job_rule
      if: $CI_COMMIT_TAG || ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH)

# Only run job in these cases:
# - if it's a tag pipeline
# - if there is a commit pushed or merged to the default branch (pre-release)
# - if there is a MR open (pre-release, unstable)
.release_or_development_job:
  rules:
    - &release_or_development_job_rule
      if: $CI_COMMIT_TAG || ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH) || ($CI_PIPELINE_SOURCE == "merge_request_event")

# Only run job in these cases:
# - if there is a MR open
.development_job:
  rules:
    - &development_job_rule
      if: ($CI_PIPELINE_SOURCE == "merge_request_event") && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH)


###############################################################################
###############################################################################
###############################################################################

verify_project_changes:
  extends:
    - .template_job
    - .pod_nano
    - .verify_merge_request
  stage: .pre
  rules:
    - *development_job_rule
  variables:
    PROJ_VER_FILE_NAME: VERSION

check-on-top-of-master:
  extends: .check-on-top-of-master
  stage: .pre
  needs: [ ]
  rules:
    - *development_job_rule

clang-format:
  extends:
    - .template_job
    - .pod_nano
  stage: .pre
  rules:
    - *development_job_rule
  variables:
    CMD_SCRIPT: |
      git fetch origin master
      git clang-format --style file --diff origin/master --extensions c,h
      git clang-format --style file --diff origin/master --extensions c,h | grep -q -e "clang-format did not modify any files$" -e "^no modified files to format$"

checkpatch:
  extends:
    - .template_job
    - .pod_nano
  stage: .pre
  rules:
    - *development_job_rule
  variables:
    CMD_SCRIPT: |
      if find -maxdepth 1 -name '*.[ch]' -not -name '*loopback*' | xargs -I {} ./scripts/checkpatch.pl --no-tree --terse --show-types --strict --file {} | grep -Pv 'OPEN_ENDED_LINE|^total:'
      then
        echo "Please resolve the issues detected by checkpatch.pl!"
        exit 1
      else
        echo "checkpatch.pl found no issue"
      fi

###############################################################################
###############################################################################
###############################################################################

create-sw-platform-branch:
  extends: .create-sw-platform-branch
  stage: generate_build
  rules:
    - *release_or_development_job_rule

generate_build:conan:
  extends:
    - .pod_nano
    - .template_job
    - .template-conan-linux-ubuntu22.04-gcc11
  stage: generate_build
  rules:
    - *release_or_development_job_rule
  variables:
    TIMEOUT: 15m
    CMD_BUILD: |
      cd conan
      python3 -m ci_build
  artifacts:
    expire_in: 4h
    paths:
      - conan/build_pipeline.yml
      - conan/lockfiles_info.json

###############################################################################
###############################################################################
###############################################################################

create-sw-platform-trigger:
  extends: .create-sw-platform-trigger
  stage: build
  needs:
    - create-sw-platform-branch
  rules:
    - *release_or_development_job_rule

build:conan:
  stage: build
  needs:
    - generate_build:conan
  rules:
    - *release_or_development_job_rule
  trigger:
    include:
    - artifact: conan/build_pipeline.yml
      job: generate_build:conan
    strategy: depend

###############################################################################
###############################################################################
###############################################################################

tests:integration-repo:
  extends: .meta-trigger
  stage: test
  needs:
    - create-sw-platform-trigger
    - build:conan
  rules:
    - *release_or_development_job_rule
  trigger:
    strategy: depend
    include:
      - artifact: generated-trigger-job.yaml
        job: create-sw-platform-trigger

###############################################################################
###############################################################################
###############################################################################

on_success:promote:
  extends:
    - .pod_nano
    - .template_job
    - .template-conan-linux-ubuntu22.04-gcc11
  stage: deploy
  needs:
    - generate_build:conan
    - build:conan
  rules:
    - *release_job_rule
  variables:
    PYTHONIOENCODING: utf-8
    CMD_BUILD: |
      cd conan
      python3 -m ci_promote
