#!/bin/bash


set -x


DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

usage() {
    echo "usage: $0 [options]"
    echo ""
    echo "  Required Options"
    echo "      --gtest-cmd|-g       gtest command to execute"
    echo "      --test-name|-t       name of the test"
    echo
}



while :
do
    case "$1" in
        --gtest-cmd|-g)
            GTEST_CMD=$2
            shift 2
            ;;
        --test-name|-t)
            TEST_NAME=$2
            shift 2
            ;;
        -h|--help)
            usage
            exit 0;
            ;;
        -*)
            echo "Error: unknown options: $1" >&2
            exit 1
            ;;
        *)
            if [ $# -eq 0 ]; then
                break
            else
                echo "Error: unknown argument: $1" >&2
                exit 1
            fi
            ;;
    esac
done

echo ${GTEST_CMD:?"No --gtest-cmd|-g specified"}
echo ${TEST_NAME:?"No --test-name|-t specified"}


( bash -c "$GTEST_CMD" )
res=$?

if [ res == 0 ];
then
   echo "Test passed, that is unexpected"
   exit 1
fi

DMP_FILES=`find @CMAKE_CURRENT_BINARY_DIR@/test_sentry_dump/${TEST_NAME}/ -iname *.dmp`

if [[ ! ${DMP_FILES} ]];
then
    echo "No breakpad files generated"
    exit 1
fi


exit 0
