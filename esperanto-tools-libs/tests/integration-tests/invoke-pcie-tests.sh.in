#!/bin/bash

# Copyright (c) 2025 Ainekko, Co.
# SPDX-License-Identifier: Apache-2.0

set -x

PROJECT_DIR=`echo "@PROJECT_BINARY_DIR@" | sed 's/build.*/build/'`
cd $PROJECT_DIR


## Clear the kmemleaks buffer so we get a clean run
sudo bash -c "echo clear > /sys/kernel/debug/kmemleak"

DEFAULT_LEVELS=$(cat /proc/sys/kernel/printk)
sudo su -c "sudo echo "6" > /proc/sys/kernel/printk"

exit_on_fail()
{
    if [ $1 -ne 0 ]; then
        sudo su -c "echo \"$DEFAULT_LEVELS\" > /proc/sys/kernel/printk"
        exit $1
    fi
}

## Load driver
cd $PROJECT_DIR/host-software/linuxDriver/tests
sudo ctest -T Start -T Test -R "load-driver" -V --no-compress-output
exit_on_fail $?

# Run the runtime tests
cd $PROJECT_DIR/host-software/runtime
ET_VLOG=1 ctest -R "pcie_" -V --no-compress-output -E "_NOSYSEMU"
exit_on_fail $?

# Issue a kmemleak scan and check the buffer for issues
FAILURE_FOUND=0
sudo bash -c "echo scan > /sys/kernel/debug/kmemleak"
if [ -s /sys/kernel/debug/kmemleak ]; then
    let "FAILURE_FOUND+=1"
    sudo cp -f /sys/kernel/debug/kmemleak $PROJECT_DIR
fi

sudo su -c "echo \"$DEFAULT_LEVELS\" > /proc/sys/kernel/printk"

exit $FAILURE_FOUND
