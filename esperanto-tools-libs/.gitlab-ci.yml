include:
  - project: 'software/conan/conan-ci-pipelines-common'
    ref: master
    file: 'mr/common.yaml'

variables:
  GIT_SUBMODULE_STRATEGY: none
  GET_SOURCES_ATTEMPTS: 2
  ARTIFACT_DOWNLOAD_ATTEMPTS: 2

###############################################################################
###############################################################################
###############################################################################

tests:sysemu:
  stage: .pre
  extends: .template_job_generic_medium_k8s_conan
  image: conanio/gcc7-ubuntu16.04
  parallel:
    matrix:
      - BUILD_TYPE: [ release, debug ]
  script:
    - sudo apt install ninja-build
    - mkdir cmake-build-${BUILD_TYPE}
    - cd cmake-build-${BUILD_TYPE}
    - conan remote disable conan-tmp
    - conan install .. -pr:b linux-ubuntu16.04-x86_64-gcc7-release -pr:h linux-ubuntu16.04-x86_64-gcc7-${BUILD_TYPE} -o runtime:with_tests=True -o esperanto-flash-tool:header_only=True --build missing
    - cmake --configure .. -DCMAKE_TOOLCHAIN_FILE=conan/conan_toolchain.cmake -G Ninja
    - cmake --build .
    - ctest -T Test -L 'Generic' --no-compress-output --parallel 2

## 

gen_conan_build_pipeline:
  extends: .template_job_k8s_with_conan_ci_pipelines_common
  stage: .pre
  image: conanio/gcc7-ubuntu16.04
  script:

    # generate pipeline
    - |
      conan-ci-pipelines-common/gen-build-pipeline.py \
          ci/src/conan.yaml \
          conan-ci-pipelines-common/consumers.yaml \
          conan-ci-pipelines-common/configs.yaml \
          -o build-pipeline.yaml

    - sh -c -x "${CMD_AFTER_GENERATE_PIPELINE}"

###############################################################################
###############################################################################
###############################################################################

conan_build_pipeline:
  stage: build
  needs:
    - gen_conan_build_pipeline
  variables:
    UPSTREAM_PROJECT_NAME:      ${CI_PROJECT_NAME}
    UPSTREAM_CI_PIPELINE_ID:    ${CI_PIPELINE_ID}
    CONAN_CI_PIPELINES_COMMON_REF: ${CONAN_CI_PIPELINES_COMMON_REF}
    CONAN_CONFIG_EXTRA_ARGS: ${CONAN_CONFIG_EXTRA_ARGS}
  trigger:
    include:
      - artifact: build-pipeline.yaml
        job: gen_conan_build_pipeline
    strategy: depend

###############################################################################
###############################################################################
###############################################################################


###############################################################################
###############################################################################
###############################################################################

on_success:promote:
  extends: .template_job_k8s_with_conan_ci_pipelines_common_on_success_perform_promote
  stage: deploy
  needs:
    - gen_conan_build_pipeline
    - conan_build_pipeline
    - tests:sysemu

on_failure:report:
  extends: .template_job_k8s_bare_minimum_on_failure_report
  stage: deploy
