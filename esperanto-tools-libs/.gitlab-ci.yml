include:
  - project: 'software/gitlab-ci-common'
    ref: eaa145e684411db579462b41feb7736c6ed0028c
    file:
      - 'pods/nano-pod.yaml'
      - 'jobs/generic-k8s-job.yaml'

  - project: 'software/gitlab-ci-common'
    ref: master
    file:
      - 'jobs/conan-jobs.yaml'

stages:
  - smoke
  - generate_build
  - build
  - test
  - deploy


###############################################################################
###############################################################################
###############################################################################

unit_tests:conan:sysemu:
  extends:
    - .pod_nano
    - .template_job
    - .template-conan-linux-ubuntu18.04-gcc7
  
  stage: smoke

  parallel:
    matrix:
      - BUILD_TYPE: [ release, debug ]
  
  variables:
    TIMEOUT: 30m

    CMD_BUILD: |
      sudo apt install ninja-build
      mkdir cmake-build-${BUILD_TYPE}
      cd cmake-build-${BUILD_TYPE}
      conan remote disable conan-tmp
      conan install .. -pr:b default -pr:h linux-ubuntu16.04-x86_64-gcc7-${BUILD_TYPE} -o runtime:with_tests=True -o esperanto-flash-tool:header_only=True --build missing
      cmake --configure .. -DCMAKE_TOOLCHAIN_FILE=conan/conan_toolchain.cmake -G Ninja
      cmake --build .
      ctest -T Test -L 'Generic' --no-compress-output --parallel 2

###############################################################################
###############################################################################
###############################################################################


generate_build:conan:
  extends:
    - .pod_nano
    - .template_job
    - .template-conan-linux-ubuntu18.04-gcc7
  stage: generate_build

  variables:
    TIMEOUT: 15m

    CMD_BUILD: |
      cd conan
      python3 -m ci_build
  
  artifacts:
    expire_in: 1h 
    paths:
      - conan/build_pipeline.yml
      - conan/lockfiles_info.json

###############################################################################
###############################################################################
###############################################################################

build:conan:
  stage: build
  needs:
  - generate_build:conan
  stage: build
  trigger:
    include:
    - artifact: conan/build_pipeline.yml
      job: generate_build:conan
    strategy: depend

###############################################################################
###############################################################################
###############################################################################

# integration tests could go here

###############################################################################
###############################################################################
###############################################################################

on_success:promote:
  extends:
    - .pod_nano
    - .template_job
    - .template-conan-linux-ubuntu18.04-gcc7
  
  stage: deploy

  needs:
    - generate_build:conan
    - build:conan
  
  variables:
    PYTHONIOENCODING: utf-8
    CMD_BUILD: |
      cd conan
      python3 -m ci_promote